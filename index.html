<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Easy Bill â€“ Local Demo</title>
    <style>
        :root {
            --primary: #6366f1;          /* Indigo */
            --primary-dark: #4f46e5;
            --accent: #ec4899;           /* Pink */
            --accent-soft: #fce7f3;
            --danger: #ef4444;
            --bg: #0f172a;
            --card-bg: #ffffff;
            --border: #e5e7eb;
            --text-main: #0f172a;
            --text-muted: #6b7280;
            --radius-lg: 14px;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 24px;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: radial-gradient(circle at top left, #22d3ee, #6366f1, #0f172a);
            color: var(--text-main);
        }

        .app-container {
            max-width: 1100px;
            margin: 0 auto;
        }

        .app-header {
            margin-bottom: 20px;
            color: #f9fafb;
        }

        .app-title {
            font-size: 26px;
            font-weight: 800;
            margin: 0 0 6px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .app-title span.icon {
            width: 30px;
            height: 30px;
            border-radius: 999px;
            background: rgba(15, 23, 42, 0.4);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        .app-subtitle {
            margin: 0;
            font-size: 13px;
            color: #e5e7eb;
        }

        .badge {
            font-size: 10px;
            padding: 3px 8px;
            border-radius: 999px;
            background: rgba(15, 23, 42, 0.7);
            color: #a5b4fc;
            text-transform: uppercase;
            letter-spacing: 0.08em;
        }

        .card {
            background: var(--card-bg);
            border-radius: var(--radius-lg);
            padding: 18px 18px 14px;
            margin-bottom: 16px;
            border: 1px solid rgba(148, 163, 184, 0.35);
            box-shadow:
                0 18px 45px rgba(15, 23, 42, 0.35),
                0 0 0 1px rgba(255, 255, 255, 0.3);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 14px;
        }

        .card-title {
            font-size: 16px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-main);
        }

        .card-title-icon {
            width: 24px;
            height: 24px;
            border-radius: 999px;
            background: linear-gradient(135deg, #a855f7, #ec4899);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 13px;
            color: #f9fafb;
            box-shadow: 0 6px 14px rgba(236, 72, 153, 0.55);
        }

        .card-subtitle {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 2px;
        }

        .layout-row {
            display: flex;
            flex-wrap: wrap;
            margin: -6px;
        }

        .layout-item {
            flex: 1 1 200px;
            padding: 6px;
            min-width: 200px;
        }

        .field-label {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            font-size: 12px;
            margin-bottom: 4px;
            color: var(--text-muted);
        }

        .field-label strong {
            color: var(--text-main);
            font-weight: 600;
        }

        .field-helper {
            font-size: 11px;
            color: var(--accent);
        }

        input {
            width: 100%;
            padding: 8px 9px;
            border-radius: 10px;
            border: 1px solid rgba(148, 163, 184, 0.9);
            font-size: 13px;
            outline: none;
            transition: border-color 0.15s, box-shadow 0.15s, background-color 0.15s, transform 0.08s;
            background: linear-gradient(135deg, #eef2ff, #e0f2fe);
        }

        input:focus {
            border-color: var(--primary);
            box-shadow:
                0 0 0 1px rgba(129, 140, 248, 0.6),
                0 8px 18px rgba(79, 70, 229, 0.3);
            background: #ffffff;
            transform: translateY(-1px);
        }

        .items-header {
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: baseline;
        }

        .items-header-right {
            font-size: 11px;
            color: var(--accent);
            font-weight: 600;
        }

        .item-row {
            display: flex;
            flex-wrap: wrap;
            margin: 0 -4px 10px;
            padding: 9px 7px;
            border-radius: 12px;
            background: radial-gradient(circle at top left, #eef2ff, #fce7f3);
            border: 1px solid rgba(129, 140, 248, 0.6);
        }

        .item-col {
            flex: 1 1 150px;
            padding: 4px;
            min-width: 150px;
        }

        .item-actions {
            display: flex;
            align-items: flex-end;
            justify-content: center;
            min-width: 70px;
        }

        .btn {
            padding: 8px 14px;
            font-size: 13px;
            border-radius: 999px;
            border: none;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            transition:
                transform 0.08s ease-out,
                box-shadow 0.08s ease-out,
                background-color 0.15s,
                opacity 0.15s;
            white-space: nowrap;
        }

        .btn:active {
            transform: translateY(1px);
            box-shadow: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--accent));
            color: white;
            box-shadow: 0 12px 26px rgba(99, 102, 241, 0.55);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #22c55e, #14b8a6);
            color: #ecfdf5;
            box-shadow: 0 10px 20px rgba(34, 197, 94, 0.4);
        }

        .btn-upload {
            background: linear-gradient(135deg, #0ea5e9, #6366f1);
            color: #e0f2fe;
            box-shadow: 0 10px 20px rgba(14, 165, 233, 0.45);
        }

        .btn-download {
            background: linear-gradient(135deg, #f97316, #eab308);
            color: #1f2937;
            box-shadow: 0 12px 26px rgba(248, 171, 31, 0.55);
        }

        .btn-danger {
            background: #fee2e2;
            color: #b91c1c;
            border: 1px solid #fecaca;
        }

        .btn-icon {
            width: 28px;
            height: 28px;
            border-radius: 999px;
            padding: 0;
            justify-content: center;
        }

        .btn + .btn {
            margin-left: 8px;
        }

        .button-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
            gap: 8px;
            flex-wrap: wrap;
        }

        .button-group {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .footer-note {
            margin-top: 8px;
            font-size: 11px;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .dot {
            width: 7px;
            height: 7px;
            border-radius: 999px;
            background: #22c55e;
            box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.3);
        }

        .hidden {
            display: none;
        }

        @media (max-width: 700px) {
            body {
                padding: 16px;
            }

            .card {
                padding: 14px;
            }
        }
    </style>
</head>
<body>
<div class="app-container">
    <header class="app-header">
        <div class="app-title">
            <span class="icon">ðŸ§®</span>
            Easy Bill
            <span class="badge">Local Preview</span>
        </div>
        <p class="app-subtitle">
            Configure items, bill range & GST, then generate voucher-wise CSV ready for Excel.
        </p>
    </header>

    <!-- Download Excel card -->
    <div class="card">
        <div class="card-header">
            <div>
                <div class="card-title">
                    <span class="card-title-icon">â¬‡</span>
                    Generated Excel
                </div>
                <div class="card-subtitle">
                    Step 2: After you submit configuration, this button becomes active.
                </div>
            </div>
        </div>
        <!-- Hidden initially, shown after Submit -->
        <button id="downloadExcelBtn" class="btn btn-download hidden">
            â¬‡ Download Excel (CSV)
        </button>
    </div>

    <!-- Filters / header inputs -->
    <div class="card">
        <div class="card-header">
            <div>
                <div class="card-title">
                    <span class="card-title-icon">âš™</span>
                    Bill Filters
                </div>
                <div class="card-subtitle">
                    Date range, voucher numbers and Max Bill Amount (incl GST).
                </div>
            </div>
        </div>

        <div class="layout-row">
            <div class="layout-item">
                <div class="field-label">
                    <strong>From Date</strong>
                </div>
                <input type="date" id="fromDate" />
            </div>

            <div class="layout-item">
                <div class="field-label">
                    <strong>To Date</strong>
                </div>
                <input type="date" id="toDate" />
            </div>

            <div class="layout-item">
                <div class="field-label">
                    <strong>Start Bill Number</strong>
                </div>
                <input type="number" id="billStartNumber" min="1" />
            </div>

            <div class="layout-item">
                <div class="field-label">
                    <strong>End Bill Number</strong>
                </div>
                <input type="number" id="billEndNumber" min="1" />
            </div>

            <div class="layout-item">
                <div class="field-label">
                    <strong>Max Bill Amount</strong>
                    <span class="field-helper">Per voucher (Incl GST)</span>
                </div>
                <input type="number" id="maxBillAmount" min="1" />
            </div>
        </div>
    </div>

    <!-- Item list card -->
    <div class="card">
        <div class="card-header items-header">
            <div>
                <div class="card-title">
                    <span class="card-title-icon">ðŸ§¾</span>
                    Item List
                </div>
                <div class="card-subtitle">
                    Enter manually or upload from Excel / CSV. Prices are inclusive of GST.
                </div>
            </div>
            <div class="items-header-right" id="itemsCountLabel">
                1 item configured
            </div>
        </div>

        <div id="itemsContainer"></div>

        <div class="button-row">
            <div class="button-group">
                <button id="uploadItemsBtn" class="btn btn-upload">ðŸ“¤ Upload Items</button>
                <button id="addItemBtn" class="btn btn-secondary">ï¼‹ Add Item</button>
            </div>
            <div class="button-group">
                <button id="submitBtn" class="btn btn-primary">âœ“ Submit Configuration</button>
            </div>
        </div>

        <div class="footer-note">
            <span class="dot"></span>
            <span>
                NET PRICE / NET AMT are excluding GST. FINAL INVOICE is inclusive of GST.
            </span>
        </div>
    </div>
</div>

<!-- Hidden file input for upload -->
<input
    type="file"
    id="fileInput"
    class="hidden"
    accept=".csv, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel"
/>

<!-- SheetJS for Excel parsing -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<script>
    // ------------------ STATE (mirrors LWC fields) ------------------
    let billStartNumber;
    let billEndNumber;
    let startDate;
    let endDate;
    let maxBillAmount;

    let items = [
        {
            id: 0,
            name: '',
            quantity: null,
            higestunitPrice: null,
            lowestunitPrice: null,
            gstRate: null,
            variance: null
        }
    ];

    let nextId = 1;

    // ------------------ DOM REFERENCES ------------------
    const fromDateInput = document.getElementById('fromDate');
    const toDateInput = document.getElementById('toDate');
    const billStartNumberInput = document.getElementById('billStartNumber');
    const billEndNumberInput = document.getElementById('billEndNumber');
    const maxBillAmountInput = document.getElementById('maxBillAmount');

    const itemsContainer = document.getElementById('itemsContainer');
    const itemsCountLabel = document.getElementById('itemsCountLabel');
    const addItemBtn = document.getElementById('addItemBtn');
    const uploadItemsBtn = document.getElementById('uploadItemsBtn');
    const submitBtn = document.getElementById('submitBtn');
    const downloadExcelBtn = document.getElementById('downloadExcelBtn');
    const fileInput = document.getElementById('fileInput');

    // ------------------ TOAST (browser version of ShowToastEvent) ------------------
    function showErrorToast(message) {
        console.error(message);
        alert('Error: ' + message);
    }

    // ------------------ HEADER FIELD HANDLERS ------------------
    function handleBillStartNumberChange(e) { billStartNumber = e.target.value; }
    function handleBillEndNumberChange(e) { billEndNumber = e.target.value; }
    function handleFromDateChange(e) { startDate = e.target.value; }
    function handleToDateChange(e) { endDate = e.target.value; }
    function handleMaxBillAmountChange(e) { maxBillAmount = e.target.value; }

    fromDateInput.addEventListener('change', handleFromDateChange);
    toDateInput.addEventListener('change', handleToDateChange);
    billStartNumberInput.addEventListener('change', handleBillStartNumberChange);
    billEndNumberInput.addEventListener('change', handleBillEndNumberChange);
    maxBillAmountInput.addEventListener('change', handleMaxBillAmountChange);

    // ------------------ ITEM RENDERING ------------------
    function renderItems() {
        itemsContainer.innerHTML = '';

        items.forEach((item, index) => {
            const rowDiv = document.createElement('div');
            rowDiv.className = 'item-row';
            rowDiv.dataset.index = index;

            rowDiv.appendChild(
                createInputCol('Item Name', 'text', 'name', index, item.name)
            );
            rowDiv.appendChild(
                createInputCol('Quantity', 'number', 'quantity', index, item.quantity)
            );
            rowDiv.appendChild(
                createInputCol(
                    'Lowest Unit Price (Incl GST)',
                    'number',
                    'lowestunitPrice',
                    index,
                    item.lowestunitPrice
                )
            );
            rowDiv.appendChild(
                createInputCol(
                    'Highest Unit Price (Incl GST)',
                    'number',
                    'higestunitPrice',
                    index,
                    item.higestunitPrice
                )
            );
            rowDiv.appendChild(
                createInputCol(
                    'Variance Step',
                    'number',
                    'variance',
                    index,
                    item.variance
                )
            );
            rowDiv.appendChild(
                createInputCol(
                    'GST Rate (%)',
                    'number',
                    'gstRate',
                    index,
                    item.gstRate
                )
            );

            const deleteCol = document.createElement('div');
            deleteCol.className = 'item-col item-actions';
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'btn btn-danger btn-icon';
            deleteBtn.textContent = 'âœ•';
            deleteBtn.title = 'Delete row';
            deleteBtn.dataset.id = item.id;
            deleteBtn.addEventListener('click', handleDelete);
            deleteCol.appendChild(deleteBtn);
            rowDiv.appendChild(deleteCol);

            itemsContainer.appendChild(rowDiv);
        });

        updateItemsCountLabel();
    }

    function createInputCol(labelText, type, name, index, value) {
        const colDiv = document.createElement('div');
        colDiv.className = 'item-col';

        const labelDiv = document.createElement('div');
        labelDiv.className = 'field-label';
        const label = document.createElement('strong');
        label.textContent = labelText;
        labelDiv.appendChild(label);
        colDiv.appendChild(labelDiv);

        const input = document.createElement('input');
        input.type = type;
        input.name = name;
        input.dataset.index = index;
        if (value !== null && value !== undefined) {
            input.value = value;
        }
        input.addEventListener('change', handleChange);

        colDiv.appendChild(input);
        return colDiv;
    }

    function updateItemsCountLabel() {
        const count = items.length;
        itemsCountLabel.textContent =
            count === 1 ? '1 item configured' : `${count} items configured`;
    }

    // ------------------ ITEM HANDLERS ------------------
    function handleAddItem() {
        items = [
            ...items,
            {
                id: nextId++,
                name: '',
                quantity: null,
                higestunitPrice: null,
                lowestunitPrice: null,
                gstRate: null,
                variance: null
            }
        ];
        renderItems();
    }

    function handleChange(event) {
        const idx = event.target.dataset.index;
        const field = event.target.name;
        const value = event.target.value;

        const copy = [...items];
        copy[idx][field] = value;
        items = copy;
    }

    function handleDelete(event) {
        const id = Number(event.currentTarget.dataset.id);
        items = items.filter(i => i.id !== id);
        renderItems();
    }

    addItemBtn.addEventListener('click', handleAddItem);

    // ------------------ UPLOAD ITEMS (Excel / CSV) ------------------
    uploadItemsBtn.addEventListener('click', () => {
        fileInput.value = '';
        fileInput.click();
    });

    fileInput.addEventListener('change', handleFileSelected);

    function handleFileSelected(e) {
        const file = e.target.files[0];
        if (!file) return;

        const name = file.name.toLowerCase();

        if (name.endsWith('.csv')) {
            parseCsvFile(file);
        } else if (name.endsWith('.xlsx') || name.endsWith('.xls')) {
            parseExcelFile(file);
        } else {
            showErrorToast('Unsupported file type. Please upload CSV or Excel.');
        }
    }

    function parseCsvFile(file) {
        const reader = new FileReader();
        reader.onload = (evt) => {
            const text = evt.target.result;
            parseItemsFromCsvText(text);
        };
        reader.readAsText(file);
    }

    function parseItemsFromCsvText(text) {
        const lines = text.split(/\r?\n/).filter(l => l.trim().length > 0);
        if (lines.length < 2) {
            showErrorToast('CSV must have a header row and at least one data row.');
            return;
        }

        const headers = lines[0].split(',').map(h => h.trim());
        const headerMap = buildHeaderMap(headers);
        if (headerMap.itemName === undefined) {
            showErrorToast('CSV must contain an "Item Name" column.');
            return;
        }

        const newItems = [];
        for (let i = 1; i < lines.length; i++) {
            const row = lines[i].split(',');
            if (row.every(c => c.trim() === '')) continue;

            const item = buildItemFromRow(headerMap, row);
            if (item) newItems.push(item);
        }

        if (newItems.length === 0) {
            showErrorToast('No valid item rows found in CSV.');
            return;
        }

        newItems.forEach(it => {
            it.id = nextId++;
            items.push(it);
        });
        renderItems();
        alert(`${newItems.length} items added from CSV.`);
    }

    function parseExcelFile(file) {
        const reader = new FileReader();
        reader.onload = (evt) => {
            const data = new Uint8Array(evt.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const sheetName = workbook.SheetNames[0];
            const sheet = workbook.Sheets[sheetName];
            const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });

            if (!rows || rows.length < 2) {
                showErrorToast('Excel must have a header row and at least one data row.');
                return;
            }

            const headers = rows[0].map(cell => (cell || '').toString());
            const headerMap = buildHeaderMap(headers);
            if (headerMap.itemName === undefined) {
                showErrorToast('Excel must contain an "Item Name" column.');
                return;
            }

            const newItems = [];
            for (let i = 1; i < rows.length; i++) {
                const row = rows[i];
                if (!row || row.every(c => (c === null || c === undefined || c.toString().trim() === ''))) {
                    continue;
                }
                const item = buildItemFromRow(headerMap, row);
                if (item) newItems.push(item);
            }

            if (newItems.length === 0) {
                showErrorToast('No valid item rows found in Excel.');
                return;
            }

            newItems.forEach(it => {
                it.id = nextId++;
                items.push(it);
            });
            renderItems();
            alert(`${newItems.length} items added from Excel.`);
        };
        reader.readAsArrayBuffer(file);
    }

    // ---------- HEADER NORMALIZATION + MAP (MORE FORGIVING) ----------

    // Make header detection very forgiving:
    // - trim
    // - lowercase
    // - remove ALL non-alphanumeric characters
    function normalizeHeader(h) {
        if (h === null || h === undefined) return '';
        return h
            .toString()
            .trim()
            .toLowerCase()
            .replace(/[^a-z0-9]/g, ''); // removes spaces, underscores, punctuation, etc.
    }

    // Map headers -> indices (Item Name, Quantity, Lowest Unit Price, Highest Unit Price, variance, GST Rate)
    function buildHeaderMap(headers) {
        const map = {};
        const normalized = headers.map(h => normalizeHeader(h));

        console.log('Raw headers:', headers);
        console.log('Normalized headers:', normalized);

        normalized.forEach((key, i) => {
            // ITEM NAME
            if (
                map.itemName === undefined &&
                (key === 'itemname' ||
                 key === 'item' ||
                 (key.includes('item') && key.includes('name')))
            ) {
                map.itemName = i;
            }
            // QUANTITY
            else if (
                map.quantity === undefined &&
                (key === 'quantity' || key === 'qty' || key === 'quantitypcs')
            ) {
                map.quantity = i;
            }
            // LOWEST UNIT PRICE
            else if (
                map.lowestunitPrice === undefined &&
                (key === 'lowestunitprice' ||
                 key === 'lowunitprice' ||
                 key === 'lowprice')
            ) {
                map.lowestunitPrice = i;
            }
            // HIGHEST UNIT PRICE (also tolerate "higestunitprice")
            else if (
                map.higestunitPrice === undefined &&
                (key === 'highestunitprice' ||
                 key === 'higestunitprice' ||
                 key === 'highunitprice' ||
                 key === 'highprice')
            ) {
                map.higestunitPrice = i;
            }
            // VARIANCE
            else if (map.variance === undefined && key === 'variance') {
                map.variance = i;
            }
            // GST RATE
            else if (
                map.gstRate === undefined &&
                (key === 'gstrate' || key === 'gst' || key === 'taxrate')
            ) {
                map.gstRate = i;
            }
        });

        // Fallback: if still no itemName but first header looks non-empty, assume first column
        if (map.itemName === undefined && headers.length > 0) {
            const firstNorm = normalizeHeader(headers[0]);
            if (firstNorm) {
                map.itemName = 0;
            }
        }

        return map;
    }

    function toNumberOrNull(v) {
        if (v === null || v === undefined) return null;
        const num = Number(v);
        return isNaN(num) ? null : num;
    }

    function buildItemFromRow(headerMap, row) {
        const nameIdx = headerMap.itemName;
        const name = row[nameIdx] != null ? row[nameIdx].toString().trim() : '';
        if (!name) return null;

        const quantity = headerMap.quantity !== undefined ? toNumberOrNull(row[headerMap.quantity]) : null;
        const lowest = headerMap.lowestunitPrice !== undefined ? toNumberOrNull(row[headerMap.lowestunitPrice]) : null;
        const highest = headerMap.higestunitPrice !== undefined ? toNumberOrNull(row[headerMap.higestunitPrice]) : null;
        const variance = headerMap.variance !== undefined ? toNumberOrNull(row[headerMap.variance]) : null;
        const gstRate = headerMap.gstRate !== undefined ? toNumberOrNull(row[headerMap.gstRate]) : null;

        return {
            id: null,
            name,
            quantity,
            lowestunitPrice: lowest,
            higestunitPrice: highest,
            variance,
            gstRate
        };
    }

    // ------------------ SUBMIT (enable Download button) ------------------
    function handleSubmit() {
        const allInputs = document.querySelectorAll('input');
        let allValid = true;
        allInputs.forEach(input => {
            if (!input.checkValidity()) {
                allValid = false;
                input.reportValidity();
            }
        });

        if (!allValid) {
            console.log('Please correct validation errors before submitting.');
            return;
        }

        const itemsPayload = items.map(item => ({
            itemName: item.name,
            quantity: item.quantity ? Number(item.quantity) : null,
            higestunitPrice: item.higestunitPrice ? Number(item.higestunitPrice) : null,
            lowestunitPrice: item.lowestunitPrice ? Number(item.lowestunitPrice) : null,
            gstRate: item.gstRate ? Number(item.gstRate) : null,
            variance: item.variance ? Number(item.variance) : null
        }));

        const payload = {
            billStartNumber: billStartNumber ? Number(billStartNumber) : null,
            billEndNumber: billEndNumber ? Number(billEndNumber) : null,
            startDate: startDate || null,
            endDate: endDate || null,
            maxBillAmount: maxBillAmount ? Number(maxBillAmount) : null,
            items: itemsPayload
        };

        console.log('Submitted items => ', JSON.stringify(payload));
        alert('Configuration submitted. You can now Download Excel.');

        downloadExcelBtn.classList.remove('hidden');
    }

    submitBtn.addEventListener('click', handleSubmit);

    // ===========================================================
    //                   DOWNLOAD EXCEL / CSV
    // ===========================================================
    function handleDownloadExcel() {
        try {
            const itemsPayload = items.map(item => ({
                itemName: item.name,
                quantity: item.quantity ? Number(item.quantity) : 0,
                higestunitPrice: item.higestunitPrice ? Number(item.higestunitPrice) : 0,
                lowestunitPrice: item.lowestunitPrice ? Number(item.lowestunitPrice) : 0,
                gstRate: item.gstRate ? Number(item.gstRate) : 0,
                variance: item.variance ? Number(item.variance) : 0
            }));

            const payload = {
                billStartNumber: billStartNumber ? Number(billStartNumber) : null,
                billEndNumber: billEndNumber ? Number(billEndNumber) : null,
                startDate: startDate || null,
                endDate: endDate || null,
                maxBillAmount: maxBillAmount ? Number(maxBillAmount) : null,
                items: itemsPayload
            };

            if (!payload.billStartNumber ||
                !payload.billEndNumber ||
                !payload.startDate ||
                !payload.endDate ||
                !payload.maxBillAmount ||
                payload.items.length === 0
            ) {
                showErrorToast('Please fill all fields before exporting.');
                return;
            }

            const startVoucher = payload.billStartNumber;
            const endVoucher = payload.billEndNumber;
            const voucherCount = endVoucher - startVoucher + 1;

            if (voucherCount <= 0) {
                showErrorToast('Invalid voucher range.');
                return;
            }

            const maxBill = payload.maxBillAmount;
            const dateList = generateDateRange(payload.startDate, payload.endDate);
            if (dateList.length === 0) {
                showErrorToast('Invalid date range.');
                return;
            }

            const headers = [
                'Date', 'Particulars', 'Voucher Type', 'Voucher No.', 'Quantity',
                'NET PRICE', 'NET AMT', 'Cgst', 'Sgst', 'FINAL INVOICE',
                'item name', 'ledger', 'Registration Type'
            ];

            const itemsState = payload.items.map(i => ({
                ...i,
                quantity: i.quantity || 0,
                remainingQty: i.quantity || 0
            }));

            const tooBig = itemsState.find(i => (i.higestunitPrice || 0) > maxBill);
            if (tooBig) {
                showErrorToast(
                    `Max Bill Amount is less than highest unit price for item "${tooBig.itemName}". ` +
                    'Increase Max Bill Amount.'
                );
                return;
            }

            const totalQtyAllItems = itemsState.reduce((s, i) => s + i.quantity, 0);
            if (totalQtyAllItems <= 0) {
                showErrorToast('Total quantity for all items must be greater than 0.');
                return;
            }

            if (totalQtyAllItems < voucherCount) {
                showErrorToast(
                    'Total quantity of all items is less than the number of vouchers. ' +
                    'Cannot put items on every voucher with current inputs.'
                );
                return;
            }

            const vouchers = [];
            for (let vIndex = 0; vIndex < voucherCount; vIndex++) {
                vouchers.push({
                    voucherNo: startVoucher + vIndex,
                    date: dateList[vIndex % dateList.length],
                    totalGross: 0,
                    items: {}
                });
            }

            // STEP 1: seed each voucher with 1 unit
            for (let vIndex = 0; vIndex < voucherCount; vIndex++) {
                const voucher = vouchers[vIndex];

                const availableItems = itemsState.filter(i => i.remainingQty > 0);
                if (availableItems.length === 0) {
                    showErrorToast(
                        'Ran out of quantity while seeding vouchers. Adjust quantities or reduce vouchers.'
                    );
                    return;
                }

                const randItemIndex = getRandomInt(0, availableItems.length - 1);
                const item = availableItems[randItemIndex];
                const itemIndex = itemsState.indexOf(item);

                const grossPerUnit = getRandomPrice(
                    item.lowestunitPrice,
                    item.higestunitPrice,
                    item.variance
                );

                if (!grossPerUnit) {
                    showErrorToast('Unable to generate unit price from given range/variance.');
                    return;
                }

                if (grossPerUnit > maxBill) {
                    showErrorToast(
                        'A single unit price exceeds Max Bill Amount. Increase Max Bill Amount.'
                    );
                    return;
                }

                voucher.totalGross = roundTo2(voucher.totalGross + grossPerUnit);

                let row = voucher.items[itemIndex];
                if (!row) {
                    row = {
                        qty: 1,
                        grossUnitPriceIncl: grossPerUnit,
                        gstRate: item.gstRate || 0
                    };
                } else {
                    row.qty += 1;
                }
                voucher.items[itemIndex] = row;

                item.remainingQty -= 1;
            }

            // STEP 2: distribute remaining quantities
            for (let itemIndex = 0; itemIndex < itemsState.length; itemIndex++) {
                const item = itemsState[itemIndex];

                while (item.remainingQty > 0) {
                    let placed = false;
                    const maxAttempts = voucherCount * 2;

                    for (let attempt = 0; attempt < maxAttempts; attempt++) {
                        const vIdx = getRandomInt(0, voucherCount - 1);
                        const voucher = vouchers[vIdx];

                        const remainingCap = maxBill - voucher.totalGross;
                        if (remainingCap <= 0) continue;

                        let row = voucher.items[itemIndex];

                        let grossPerUnit;
                        if (row && row.grossUnitPriceIncl) {
                            grossPerUnit = row.grossUnitPriceIncl;
                        } else {
                            grossPerUnit = getRandomPrice(
                                item.lowestunitPrice,
                                item.higestunitPrice,
                                item.variance
                            );
                            if (!grossPerUnit) continue;
                        }

                        if (grossPerUnit > remainingCap) continue;

                        const maxByCap = Math.floor(remainingCap / grossPerUnit);
                        const maxByQty = item.remainingQty;
                        const maxQtyHere = Math.min(maxByCap, maxByQty);
                        if (maxQtyHere <= 0) continue;

                        const qtyToAdd = getRandomInt(1, maxQtyHere);

                        voucher.totalGross = roundTo2(
                            voucher.totalGross + grossPerUnit * qtyToAdd
                        );

                        if (!row) {
                            row = {
                                qty: qtyToAdd,
                                grossUnitPriceIncl: grossPerUnit,
                                gstRate: item.gstRate || 0
                            };
                        } else {
                            row.qty += qtyToAdd;
                        }
                        voucher.items[itemIndex] = row;

                        item.remainingQty -= qtyToAdd;
                        placed = true;
                        break;
                    }

                    if (!placed) {
                        showErrorToast(
                            'Cannot allocate all item quantities without exceeding Max Bill Amount. ' +
                            'Try reducing number of vouchers or increasing Max Bill Amount.'
                        );
                        return;
                    }
                }
            }

            // BUILD CSV ROWS
            const rows = [];

            for (const v of vouchers) {
                const itemIndexes = Object.keys(v.items);
                if (itemIndexes.length === 0) {
                    showErrorToast(
                        'A voucher ended up with no items. Please adjust inputs.'
                    );
                    return;
                }

                itemIndexes.forEach(idxStr => {
                    const idx = Number(idxStr);
                    const row = v.items[idx];
                    const qty = row.qty;
                    const grossPerUnit = row.grossUnitPriceIncl;
                    const gstRate = row.gstRate || 0;

                    const grossTotal = roundTo2(grossPerUnit * qty); // FINAL invoice total

                    let netAmt, netUnitPriceExcl, cgst, sgst, finalInvoice;
                    if (gstRate > 0) {
                        netAmt = roundTo2(grossTotal / (1 + gstRate / 100));
                        const totalGst = roundTo2(grossTotal - netAmt);
                        cgst = roundTo2(totalGst / 2);
                        sgst = roundTo2(totalGst - cgst);
                        finalInvoice = grossTotal;
                        netUnitPriceExcl = roundTo2(netAmt / qty);
                    } else {
                        netAmt = grossTotal;
                        cgst = 0;
                        sgst = 0;
                        finalInvoice = grossTotal;
                        netUnitPriceExcl = roundTo2(grossPerUnit);
                    }

                    rows.push([
                        v.date,
                        'Cash',
                        'C SALE',
                        v.voucherNo,
                        qty,
                        netUnitPriceExcl.toFixed(2),
                        netAmt.toFixed(2),
                        cgst.toFixed(2),
                        sgst.toFixed(2),
                        finalInvoice.toFixed(2),
                        itemsState[idx].itemName,
                        'SALE GST',
                        'Unregistered/Consumer'
                    ]);
                });
            }

            if (rows.length === 0) {
                showErrorToast('No rows could be generated with current settings.');
                return;
            }

            let csvContent = headers.join(',') + '\n';
            rows.forEach(r => {
                const escaped = r.map(v => {
                    const s = v != null ? v.toString() : '';
                    return s.includes(',') ? `"${s}"` : s;
                });
                csvContent += escaped.join(',') + '\n';
            });

            const blob = new Blob([csvContent], { type: 'application/octet-stream' });
            const url = URL.createObjectURL(blob);

            const startStr = payload.startDate.replace(/-/g, '');
            const endStr = payload.endDate.replace(/-/g, '');
            const a = document.createElement('a');
            a.href = url;
            a.download = `BillsExport_${startStr}_to_${endStr}.csv`;

            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

        } catch (e) {
            console.error(e);
            showErrorToast('Unexpected error while generating export.');
        }
    }

    downloadExcelBtn.addEventListener('click', handleDownloadExcel);

    // ---------------- HELPERS ----------------
    function getRandomInt(min, max) {
        const mi = Math.ceil(min);
        const ma = Math.floor(max);
        return Math.floor(Math.random() * (ma - mi + 1)) + mi;
    }

    function getRandomPrice(lowest, highest, variance) {
        const step = variance > 0 ? variance : 5;
        const minMult = Math.ceil(lowest / step);
        const maxMult = Math.floor(highest / step);
        if (maxMult < minMult) return null;
        const multiplier = getRandomInt(minMult, maxMult);
        return step * multiplier;
    }

    function generateDateRange(start, end) {
        const result = [];
        const d1 = new Date(start);
        const d2 = new Date(end);

        if (isNaN(d1.getTime()) || isNaN(d2.getTime())) return result;

        for (let d = new Date(d1); d <= d2; d.setDate(d.getDate() + 1)) {
            result.push(d.toISOString().slice(0, 10));
        }
        return result;
    }

    function roundTo2(v) {
        if (v === null || v === undefined || isNaN(v)) return 0;
        return Math.round(v * 100) / 100;
    }

    // Initial render
    renderItems();
</script>
</body>
</html>
